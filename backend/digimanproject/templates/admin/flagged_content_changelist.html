{% extends "admin/change_list.html" %}

{% block object-tools %}
    <div class="object-tools">
        <ul>
            <li>
                <button id="run-moderation-btn" class="button">
                    ðŸ”„ Run Moderation Pipeline
                </button>
            </li>
            <li>
                <span id="moderation-status" style="margin-left:10px; font-weight:bold;">
                    Checking moderation statusâ€¦
                </span>
            </li>
        </ul>
    </div>
    {{ block.super }}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
async function fetchStatus() {
    const response = await fetch("{% url 'admin:moderation_status' %}");
    const data = await response.json();

    const status = data.status;
    const statusEl = document.getElementById("moderation-status");
    const btn = document.getElementById("run-moderation-btn");

    const map = {
        idle: "Moderation is idle",
        starting: "Waking moderation engineâ€¦",
        queued: "Task queuedâ€¦",
        running: "Moderation is runningâ€¦",
        completed: "Moderation completed",
        failed: "Moderation failed"
    };
    
    statusEl.textContent = map[status] || "Unknown status";
    btn.disabled = ["starting", "queued", "running"].includes(status);
    
    if (status === "completed" || status === "failed") {
        setTimeout(() => window.location.reload(), 1000);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    fetchStatus();
    setInterval(fetchStatus, 3000); // For 3 seconds

    document.getElementById("run-moderation-btn").onclick = () => {
        window.location.href = "{% url 'admin:run_moderation' %}";
    };
});
</script>
{% endblock %}